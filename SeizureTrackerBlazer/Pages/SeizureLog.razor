@page "/"
@attribute [Authorize]
@inject StateContainer StateContainer


<PageTitle>Seizure Log</PageTitle>
<div class="container flex py-5">
    <EditForm EditContext="@_editContext" class="row justify-content-center" OnValidSubmit="submit"
              FormName="SeizureLog">
        <div class="col-md-3">
            <InputComponent InputType="@InputTypes.Input" InputDataType="@InputDataTypes.Date"
                            LabelText="@InputLabels.DateOfSeizure"
                            @bind-value="@Model!.SeizureDate"
            />
        </div>
        <div class="col-md-3">
            <InputComponent InputType="@InputTypes.Input" InputDataType="@InputDataTypes.Time"
                            LabelText="@InputLabels.TimeOfSeizure"
                            @bind-value="@Model!.SeizureTime"/>
        </div>
        <div class="col-md-3">
            <InputComponent InputType="@InputTypes.Input" InputDataType="@InputDataTypes.Number"
                            LabelText="@InputLabels.Intensity"
                            @bind-value="@Model!.SeizureIntensity" Placeholder="@PlaceholderLabels.Intensity"/>
        </div>
        <div class="col-md-4 py-4">
            <InputComponent Value="@Model!.SeizureType" ValueChanged="onSeizureTypeSelectChange" SelectItems="@StateContainer.SeizureType"
                            OptionLabel="@OptionLabels.SeizureType"
                            InputType="@InputTypes.Select" LabelText="@AriaLabels.SeizureType"
            />
            @foreach (var type in _seizureTypesSelected)
            {
                <span class="badge rounded-pill text-bg-info align-items-center">@type<i onclick="@(() => removeSeizureType(type))"
                                                                                         class="bi bi-x-circle-fill fs-6 ms-2"
                                                                                         role="button"></i></span>
            }
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-primary btn-lg">Submit</button>
        </div>
    </EditForm>
</div>

@code
{
    private bool _showMultiSelect;
    private string _multiSelectText;
    private string _seizureTypeInput;
    private EditContext? _editContext;
    private ValidationMessageStore _messageStore;
    private List<string> _seizureTypesSelected;

    [Parameter] public EventCallback<string> OnInputCallback { get; set; }
    [SupplyParameterFromForm] private SeizureLogForm? Model { get; set; }


    protected override void OnInitialized()
    {
        Model ??= new();
        StateContainer.EditContext = new(Model);
        _editContext.OnValidationRequested += HandleValidationRequested;
        _messageStore = new(_editContext);
        StateContainer.OnChange += StateHasChanged;
        _multiSelectText = UIConstants.MultiSelectShowText;
        _seizureTypesSelected = new();
    }

    protected override void OnParametersSet()
    {
    }

    protected override void OnAfterRender(bool firstRender)
    {
    }

    internal void HandleValidationRequested(object? sender, ValidationRequestedEventArgs args)
    {
        _messageStore?.Clear();

        // Custom validation logic
        // if (!Model!?.Options)
        // {
        //     _messageStore?.Add(() => Model.Options, "Select at least one.");
        // }
    }

    public void Dispose()
    {
        StateContainer.OnChange -= StateHasChanged;
    }


    private void submit()
    {
    }

    private void onSeizureTypeSelectChange(string value)
    {
        _seizureTypesSelected.Add(value);
        Model!.SeizureType = _seizureTypesSelected

        StateHasChanged();
    }

    private void removeSeizureType(string type)
    {
        var index = _seizureTypesSelected.IndexOf(type);
        
        _seizureTypesSelected.RemoveAt(index);
        
        StateHasChanged();
    }
}
