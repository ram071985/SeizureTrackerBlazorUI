@page "/manage-passkeys"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject HttpClient Http
@inject IJSRuntime JS

<div class="container mt-4">
    <h3>Security & Biometrics</h3>
    <div class="alert alert-info">
        Registering this device allows you to log in instantly without a password.
    </div>

    <div class="card mb-3">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <strong>FaceID / Fingerprint</strong>
                <p class="text-muted mb-0">Use your device biometrics for quick entry.</p>
            </div>
            <button @onclick="HandleRegister" class="btn btn-outline-primary">
                Register Device
            </button>
        </div>
    </div>
    
    <a href="/dashboard" class="btn btn-link">Back to Dashboard</a>
</div>

@code {
    private async Task HandleRegister()
    {
        try
        {
            // 1. Request Creation Options from API
            var response = await Http.PostAsync("api/auth/register-options", null);
            var optionsJson = await response.Content.ReadAsStringAsync();

            // 2. Trigger Browser "Create Passkey" Ceremony
            var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/passkeys.js");
            var credentialJson = await module.InvokeAsync<string>("registerPasskey", optionsJson);

            // 3. Send Public Key to API to save in AspNetUserPasskeys table
            var result = await Http.PostAsJsonAsync("api/auth/register-complete", credentialJson);

            if (result.IsSuccessStatusCode)
            {
                // Logic to refresh UI or show success message
                Console.WriteLine("Biometrics linked!");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Registration failed: {ex.Message}");
        }
    }
}