@page "/manage-passkeys"
@attribute [Authorize]
@inject AccountClient AccountClient
@inject IJSRuntime JS

<div class="container mt-4">
    <h3 class="text-white">Security & Biometrics</h3>
    <div class="alert app-alert-info">
        Registering this device allows you to log in instantly without a password.
    </div>

    <div class="card mb-3 app-dark-card">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <strong class="text-white">FaceID / Fingerprint</strong>
                <p class="text-biometric-details mb-0">Use your device biometrics for quick entry.</p>
            </div>
            <button @onclick="HandleRegister" class="btn btn-outline-primary">
                Register Device
            </button>
        </div>
    </div>
    
    <a href="/" class="btn btn-link app-link-primary">Back to Home</a>
</div>

@code {
    private async Task HandleRegister()
    {
        try
        {
            // 1. Request Creation Options from API
   
            var jsonOptions = await AccountClient.GetRegisterPasskeyOptionsAsync();

            // 2. Trigger Browser "Create Passkey" Ceremony
            var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/passkeys.js");
            var credentialJson = await module.InvokeAsync<string>("registerPasskey", jsonOptions.Data);

            // 3. Send Public Key to API to save in AspNetUserPasskeys table
            var result = await AccountClient.RegisterPasskeyFinishAsync(credentialJson);

            if (result.Success)
            {
                // Logic to refresh UI or show success message
                Console.WriteLine("Biometrics linked!");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Registration failed: {ex.Message}");
        }
    }
}