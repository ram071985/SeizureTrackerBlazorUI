@page "/login"
@attribute [AllowAnonymous]
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@inject AccountClient AccountClient
@inject IdentityAuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject LocalStorageHelper LocalStorage

<div class="container mt-5" style="max-width: 400px;">
    @if (_authLoading)
    {
        <div class="d-flex align-items-center justify-content-center">
            <SpinnerComponent Color="text-info"></SpinnerComponent>
        </div>
    }
    else
    {
        <div class="card shadow-sm p-4 text-center border-0">
            <h2 class="mb-4 text-primary">Seizure Tracker</h2>
            <input type="text" autocomplete="username webauthn" style="display:none;"/>
            <div class="form-group mb-3 text-start">
                <label class="form-label">Email Address</label>
                <input @bind="_email" class="form-control form-control-lg" placeholder="name@example.com"/>

                <label class="form-label mt-2">Password</label>
                <input type="password" @bind="_password" class="form-control form-control-lg"
                       placeholder="Your secret password" autocomplete="current-password"/>
            </div>

            <!-- Primary Password Login -->
            <button @onclick="HandlePasswordLogin" class="btn btn-primary btn-lg w-100 py-3 mb-2">
                <i class="bi bi-shield-lock me-2"></i> Login with Password
            </button>
            <div class="mt-4 border-top pt-3">
                <p class="text-muted small mb-1">New here?</p>
                <a href="/register" class="btn btn-outline-secondary btn-sm w-100">
                    Create a New Account
                </a>
            </div>

            <!-- Biometric Login (FaceID / TouchID) -->
            <button @onclick="HandlePasskeyLogin" class="btn btn-outline-success btn-lg w-100 py-3 mb-3">
                <i class="bi bi-person-badge me-2"></i> Login with FaceID
            </button>

            <p class="text-muted small">
                New here? Log in with your password first to <a href="/manage-passkeys">enable biometrics</a>.
            </p>
        </div>
    }
</div>

@code {
    private string _email = string.Empty;
    private string _password = string.Empty;
    private string _errorMessage = string.Empty;
    private bool _isProcessing;
    private bool _hasTriggered = false;
    private bool _enableAutomaticPasskeyPrompt = true;
    private bool _authLoading;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasTriggered)
        {
            _hasTriggered = true;
            
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity is not null && user.Identity.IsAuthenticated)
            {
                // User is already logged in (likely from the forceLoad reload)
                // Redirect them to the dashboard and exit
                Navigation.NavigateTo("/");
                return;
            }

            await Task.Delay(500);

            await TriggerImmediateBiometricPrompt();

            _hasTriggered = false;
        }
    }

    private async Task TriggerImmediateBiometricPrompt()
    {
        _authLoading = true;

        if (!_enableAutomaticPasskeyPrompt) return;
        try
        {
            // 1. Request a "Discoverable" challenge (no email specified)
            // This asks the device: "Do you have any face/fingerprint for this app?"
            var optionsResult = await AccountClient.GetPasskeyOptionsAsync(string.Empty);

            if (!optionsResult.Success || string.IsNullOrEmpty(optionsResult.Data))
            {
                // Fail silently: Server might not support discoverable credentials 
                // or the network is down. User can still use password.
                return;
            }

            var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/passkeys.js");

            // 2. Trigger the OS biometric prompt
            // Use a timeout or mediation 'conditional' in JS to prevent blocking the UI
            var credentialJson = await module.InvokeAsync<string>("authenticatePasskeyImmediate", optionsResult.Data);

            if (!string.IsNullOrEmpty(credentialJson))
            {
                // 3. Verify signature and log in
                var loginResult = await AccountClient.LoginWithPasskeyAsync(credentialJson);

                if (loginResult.Success)
                {
                    if (AuthStateProvider is IdentityAuthenticationStateProvider customProvider)
                    {
                        // Update UI state before navigating
                        customProvider.NotifyUserAuthentication("PasskeyUser");
                    }

                    Navigation.NavigateTo("/", forceLoad: true);
                }
            }
        }
        catch (JSException jsEx)
        {
            // Handle common Browser/Hardware errors
            if (jsEx.Message.Contains("NotAllowedError"))
            {
                // User cancelled the prompt or timed out. 
                // We do nothing so they can still see the manual login form.
                Console.WriteLine("Biometric prompt ignored by user.");
            }
            else if (jsEx.Message.Contains("SecurityError"))
            {
                _errorMessage = "Biometrics unavailable. Check your device settings.";
            }
        }
        catch (Exception ex)
        {
            // Infrastructure errors (API down, etc.)

            // We don't show an alert here because it's an 'auto' background task.
            // Let the user use the manual buttons instead.
        }

        _authLoading = false;
    }

    private async Task HandlePasswordLogin()
    {
        if (string.IsNullOrWhiteSpace(_email) || string.IsNullOrWhiteSpace(_password))
        {
            _errorMessage = "Email and Password are required.";
            return;
        }

        _isProcessing = true;

        try
        {
            // 1. Call your existing Password Login API
            var response = await AccountClient.LoginWithPasswordAsync(_email, _password);

            if (response.Success)
            {
                Navigation.NavigateTo("manage-passkeys", forceLoad: true);
            }
            else
            {
                _errorMessage = "Invalid login attempt.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "Login failed. Please try again.";

            Console.WriteLine(ex.Message);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task HandlePasskeyLogin()
    {
        try
        {
            // 1. Get Challenge from API
            var json = await AccountClient.GetPasskeyOptionsAsync(_email);
            if (json?.Data == null) return;

            // 2. Trigger Biometric Sensor
            var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/passkeys.js");
            var credentialJson = await module.InvokeAsync<string>("authenticatePasskey", json.Data);

            // 3. Send result to API
            var loginResponseSuccess = await AccountClient.LoginWithPasskeyAsync(credentialJson);
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity is not null && user.Identity.IsAuthenticated && loginResponseSuccess.Data)
            {
                Navigation.NavigateTo("/", forceLoad: true);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Login failed: {ex.Message}");
        }
    }

}

