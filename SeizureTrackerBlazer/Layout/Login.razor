@page "/login"
@attribute [AllowAnonymous]
@using Microsoft.AspNetCore.Components.Authorization
@inject AccountClient AccountClient
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject NavigationManager Navigation

<div class="container mt-5" style="max-width: 400px;">
    <div class="card shadow-sm p-4 text-center border-0">
        <h2 class="mb-4 text-primary">Seizure Tracker</h2>

        <div class="form-group mb-3 text-start">
            <label class="form-label">Email Address</label>
            <input @bind="_email" class="form-control form-control-lg" placeholder="name@example.com" />

            <label class="form-label mt-2">Password</label>
            <input type="password" @bind="_password" class="form-control form-control-lg"
                   placeholder="Your secret password" autocomplete="current-password" />
        </div>

        <!-- Primary Password Login -->
        <button @onclick="HandlePasswordLogin" class="btn btn-primary btn-lg w-100 py-3 mb-2">
            <i class="bi bi-shield-lock me-2"></i> Login with Password
        </button>

        <!-- Biometric Login (FaceID / TouchID) -->
        <button @onclick="HandlePasskeyLogin" class="btn btn-outline-success btn-lg w-100 py-3 mb-3">
            <i class="bi bi-person-badge me-2"></i> Login with FaceID
        </button>

        <p class="text-muted small">
            New here? Log in with your password first to <a href="/Account/Manage/Passkeys">enable biometrics</a>.
        </p>
    </div>
</div>

@code {
    private string _email = string.Empty;
    private string _password = string.Empty;
    private string _errorMessage = string.Empty;
    private bool _isProcessing;
    
    private async Task HandlePasswordLogin()
    {
        if (string.IsNullOrWhiteSpace(_email) || string.IsNullOrWhiteSpace(_password))
        {
            _errorMessage = "Email and Password are required.";
            return;
        }

        _isProcessing = true;
        
        try
        {
            // 1. Call your existing Password Login API
            var response = await AccountClient.LoginWithPasswordAsync(_email, _password);

            if (response.Success)
            {
                // 2. Notify your AuthStateProvider (as you did with FaceID)
                if (AuthStateProvider is IdentityAuthenticationStateProvider customProvider)
                {
                    customProvider.NotifyUserAuthentication(_email);
                }

                // 3. Redirect to the Manage Passkeys page
                // The standard .NET 10 Identity path is "Account/Manage/Passkeys"
                Navigation.NavigateTo("manage-passkeys", forceLoad: true);
            }
            else
            {
                _errorMessage = "Invalid login attempt.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "Login failed. Please try again.";
            Console.WriteLine(ex.Message);
        }
        finally { _isProcessing = false; }
    }
    private async Task HandlePasskeyLogin()
    {
        try
        {
            // 1. Get Challenge from API
            var json = await AccountClient.GetPasskeyOptionsAsync(_email);
            if (json?.Data == null) return;

            // 2. Trigger Biometric Sensor
            var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/passkeys.js");
            var credentialJson = await module.InvokeAsync<string>("authenticatePasskey", json.Data);

            // 3. Send result to API
            var loginResponseSuccess = await AccountClient.LoginWithPasskeyAsync(credentialJson);

            if (loginResponseSuccess.Data)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
            
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Login failed: {ex.Message}");
        }
    }
}

